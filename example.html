<!DOCTYPE html>
<html>
<head>
	<title>Code editor</title>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=11" />
	<meta name="format-detection" content="telephone=no" />
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
	<meta name="robots" content="all,follow" />
	<link href="https://cdn.componentator.com/spa.min@19.css" rel="stylesheet" type="text/css" />
	<script src="https://cdn.componentator.com/spa.min@19.js"></script>
</head>
<body>

	<div data---="menu__null__type:2"></div>

	<div class="padding">
		<div style="width:600px;height:300px;border:1px solid #E0E0E0;">
			<div data---="editor__common.body__mode:clientside;contextmenu:editorcontextmenu"></div>
		</div>
	</div>

	<script>

		function editorcontextmenu(obj) {
			var opt = {};
			opt.x = obj.x;
			opt.y = obj.y;
			opt.items = [];
			opt.items.push({ id: '1', name: 'Test item 1' });
			opt.items.push({ id: '2', name: 'Test item 2' });
			opt.items.push({ id: '3', name: 'Test item 3' });
			opt.items.push({ id: '4', name: 'Test item 4' });
			opt.callback = function(selected) {
				console.log(selected);
			};
			SETTER('menu/show', opt);
		}

		COMPONENT('editor', 'parent:auto;mode:clientside', function(self, config) {

			var iframe;
			var savetimeout;
			var callbacks = {};
			var callbackid = 1;
			var skip = false;
			var init = false;

			var save = function() {
				savetimeout = null;
				send({ TYPE: 'body' }, function(msg) {
					skip = true;
					self.set(msg.value);
				});
			};

			var send = function(msg, callback) {

				if (callback) {
					var id = (callbackid++) + '';
					msg.callbackid = id;
					callbacks[id] = callback;
				}

				iframe[0].contentWindow.postMessage(STRINGIFY(msg), '*');
			};

			var onmessage = function(e) {

				var msg = e.originalEvent ? e.originalEvent.data : '';

				if (typeof(msg) !== 'string' || msg.indexOf('"totaleditor"') === -1)
					return;

				msg = PARSE(msg);

				if (msg.id !== self.ID)
					return;

				if (msg.callbackid) {
					var fn = callbacks[msg.callbackid];
					if (fn) {
						delete callbacks[msg.callbackid];
						fn(msg);
					}
					return;
				}

				switch (msg.TYPE) {
					case 'click':
						SETTER('menu/hide');
						break;
					case 'menu':
					case 'contextmenu':
						var offset = self.element.offset();
						msg.x += offset.left;
						msg.y += offset.top;
						msg.next = function(items) {
							send({ callbackid: msg.callbackid, items: items });
						};
						config.contextmenu && self.SEEX(config.contextmenu, msg);
						break;
					case 'menu_selected':
						break;
					case 'shortcut':
						break;
					case 'cursor':
						SETTER('menu/hide');
						savetimeout && clearTimeout(savetimeout);
						savetimeout = setTimeout(save, 500);
						break;
					case 'init':
						init = true;
						break;
					case 'clear':
						SETTER('editor/clear');
						break;
				}

			};

			self.make = function() {
				//self.append('<iframe src="https://cdn.componentator.com/editor/1.html?id={0}" frameborder="0" scrolling="no" allowtransparency="true" allow="geolocation *; microphone *; camera *; midi *; encrypted-media *" style="width:100%"></iframe>'.format(self.ID));
				self.append('<iframe src="editor.html?id={0}" frameborder="0" scrolling="no" allowtransparency="true" allow="geolocation *; microphone *; camera *; midi *; encrypted-media *" style="width:100%"></iframe>'.format(self.ID));
				iframe = self.find('iframe');
				self.resize();
				$(W).on('message', onmessage);
			};

			self.destroy = function() {
				$(W).off('message', onmessage);
			};

			self.replace = function(text, to) {
				send({ TYPE: 'replace', text: text, to: to });
			};

			self.save = function() {
				send({ TYPE: 'body' }, function(msg) {
					skip = true;
					send({ TYPE: 'clear' });
					self.set(msg.value);
				});
			};

			self.send = send;

			self.resize = function() {
				var parent = self.parent(config.parent);
				var w = parent.width();
				var h = parent.height();
				iframe.css({ width: w, height: h });
			};

			var settertimeout;

			self.setter = function(value) {

				if (skip) {
					skip = false;
					return;
				}

				if (init) {
					settertimeout = null;
					send({ TYPE: 'init', mode: config.mode, value: self.get() });
				} else {
					settertimeout && clearTimeout(settertimeout);
					settertimeout = setTimeout(self.setter, 100);
				}

			};

		});

		var common = {};

		common.body = '';

	</script>

</body>
</html>